<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>ç™ºæ³¨ã‚¢ã‚·ã‚¹ãƒˆ Pro</title>
  <style>
    :root {
      --primary: #16a34a;
      --primary-light: #dcfce7;
      --bg: #f3f4f6;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --danger: #ef4444;
      --warn: #f59e0b;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; font-family: 'Hiragino Sans', sans-serif;
      background: var(--bg); color: var(--text);
      padding-bottom: 80px; /* ãƒŠãƒ“ç”¨ä½™ç™½ */
      overscroll-behavior: none;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼: çŠ¶æ…‹è¡¨ç¤ºå›ºå®š */
    header {
      position: sticky; top: 0; z-index: 100;
      background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
      padding: 12px 16px; border-bottom: 1px solid #e5e7eb;
      display: flex; justify-content: space-between; align-items: center;
    }

    .date-badge {
      display: flex; align-items: center; gap: 8px;
      background: #fff; padding: 6px 12px; border-radius: 999px;
      border: 1px solid #ddd; font-weight: bold;
    }

    .status-dot {
      width: 8px; height: 8px; border-radius: 50%; background: #ccc;
      display: inline-block;
    }
    .status-online { background: var(--primary); box-shadow: 0 0 8px var(--primary); }
    .status-syncing { background: var(--warn); animation: blink 1s infinite; }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    main { padding: 12px; max-width: 800px; margin: 0 auto; }
    .view-title { font-size: 1.1em; font-weight: 800; margin: 0 0 12px 4px; display: flex; align-items: center; gap: 8px; }

    /* æ¥­è€…ãƒªã‚¹ãƒˆï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ */
    .vendor-selector {
      display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 16px;
      scrollbar-width: none;
    }
    .vendor-selector::-webkit-scrollbar { display: none; }
    .vendor-chip {
      white-space: nowrap; padding: 10px 20px; background: #fff;
      border-radius: 999px; border: 1px solid #e5e7eb; font-weight: bold; color: var(--muted);
    }
    .vendor-chip.active { background: var(--primary); color: #fff; border-color: var(--primary); }

    /* å•†å“ã‚«ãƒ¼ãƒ‰ */
    .item-card {
      background: var(--card); border-radius: 16px; padding: 16px;
      margin-bottom: 12px; box-shadow: var(--shadow);
      display: grid; grid-template-columns: 1fr auto; align-items: center;
      transition: transform 0.1s;
    }
    .item-card.has-qty { border-left: 6px solid var(--primary); }
    .item-card.shortage { border-left: 6px solid var(--warn); background: #fffcf5; }

    .item-info .name { font-weight: 800; font-size: 1.1em; margin-bottom: 4px; }
    .item-info .meta { font-size: 0.85em; color: var(--muted); }

    .counter { display: flex; align-items: center; gap: 4px; background: #f9fafb; padding: 4px; border-radius: 12px; }
    .btn-qty {
      width: 44px; height: 44px; border-radius: 10px; border: none;
      background: #fff; font-size: 1.5em; font-weight: bold; cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .qty-display { width: 50px; text-align: center; font-size: 1.2em; font-weight: 900; }

    /* åœ¨åº«å…¥åŠ›ï¼ˆã‚µãƒ–ï¼‰ */
    .stock-input-wrap { display: flex; align-items: center; gap: 4px; margin-top: 8px; font-size: 0.9em; color: var(--muted); }
    .stock-field { width: 60px; border: 1px solid #ddd; border-radius: 6px; padding: 4px; text-align: center; font-weight: bold; }

    /* ãƒœãƒˆãƒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: #fff; border-top: 1px solid #e5e7eb;
      display: grid; grid-template-columns: repeat(3, 1fr); padding: 10px 0 25px;
    }
    .nav-item {
      display: flex; flex-direction: column; align-items: center;
      gap: 4px; color: var(--muted); cursor: pointer; font-size: 0.75em; font-weight: bold;
    }
    .nav-item.active { color: var(--primary); }
    .nav-icon { font-size: 1.5em; }

    @keyframes blink { 50% { opacity: 0.3; } }

    /* è¨­å®šç”»é¢ç”¨å…¥åŠ› */
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 0.8em; font-weight: bold; color: var(--muted); margin-bottom: 4px; }
    .form-group input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 1em; }
  </style>
</head>
<body>

<header>
  <div class="date-badge">
    <input type="date" id="dateInput" onchange="handleDateChange()" style="border:none; font-family:inherit; font-size:1em; outline:none;">
  </div>
  <div id="syncIndicator" class="row" style="gap:6px; font-size:0.8em; font-weight:bold; color:var(--muted)">
    <span class="status-dot" id="dot"></span>
    <span id="syncText">READY</span>
  </div>
</header>

<main>
  <div id="view-vendors" class="view">
    <div class="vendor-selector" id="vendorSelector"></div>
    <div class="view-title" id="vendorTitle">æ¥­è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
    <div id="itemList"></div>
  </div>

  <div id="view-today" class="view" style="display:none">
    <div class="view-title">ğŸ“¦ æœ¬æ—¥ã®ç¢ºå®šç™ºæ³¨</div>
    <div id="todaySummary" class="card"></div>
    <button class="btn-qty" style="width:100%; margin-top:12px; font-size:1em; background:var(--primary); color:#fff;" onclick="copySummary()">å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼</button>
  </div>

  <div id="view-settings" class="view" style="display:none">
    <div class="view-title">âš™ï¸ è¨­å®š</div>
    <div class="card" style="background:#fff; padding:16px; border-radius:16px;">
      <div class="form-group">
        <label>GAS Webã‚¢ãƒ—ãƒªURL</label>
        <input type="text" id="gasUrl" placeholder="https://script.google.com/...">
      </div>
      <div class="form-group">
        <label>åº—èˆ—ID</label>
        <input type="text" id="storeId" placeholder="ä¾‹: Kudeta_Main">
      </div>
      <button class="btn-qty" style="width:100%; font-size:1em; background:var(--text); color:#fff;" onclick="saveSettings()">è¨­å®šã‚’ä¿å­˜</button>
    </div>
  </div>
</main>

<nav>
  <div class="nav-item active" onclick="switchTab('vendors', this)">
    <span class="nav-icon">ğŸ›’</span><span>ç™ºæ³¨å…¥åŠ›</span>
  </div>
  <div class="nav-item" onclick="switchTab('today', this)">
    <span class="nav-icon">ğŸ“‹</span><span>ãƒªã‚¹ãƒˆ</span>
  </div>
  <div class="nav-item" onclick="switchTab('settings', this)">
    <span class="nav-icon">âš™ï¸</span><span>è¨­å®š</span>
  </div>
</nav>

<script>
  // --- åˆæœŸãƒ‡ãƒ¼ã‚¿ & ãƒã‚¹ã‚¿ãƒ¼ ---
  let orders = {}; 
  let currentVendor = "";
  let master = {
    vendors: [
      {name: "å¤§å…‰", items: [{name: "ãƒã‚¿ãƒ¼", unit: "kg", ideal: 5}, {name: "ç‰›ä¹³", unit: "æœ¬", ideal: 10}]},
      {name: "é«˜ç€¬", items: [{name: "ã‚­ãƒ£ãƒ™ãƒ„", unit: "ç‰", ideal: 3}, {name: "ãƒ¬ã‚¿ã‚¹", unit: "ç‰", ideal: 2}]},
      {name: "å®‰ç”°é’æœ", items: [{name: "ç‰ã­ã", unit: "kg", ideal: 10}, {name: "äººå‚", unit: "kg", ideal: 5}]},
      {name: "ãƒãƒ«ãƒˆ", items: [{name: "åµ", unit: "ãƒ‘ãƒƒã‚¯", ideal: 20}]}
    ]
  };

  let config = JSON.parse(localStorage.getItem('orderConfig_v2') || '{"gasUrl":"","storeId":""}');

  // --- èµ·å‹•å‡¦ç† ---
  window.onload = async () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateInput').value = today;
    document.getElementById('gasUrl').value = config.gasUrl;
    document.getElementById('storeId').value = config.storeId;
    
    loadLocalOrders();
    if(config.gasUrl) await pullFromCloud(); // èµ·å‹•æ™‚ã«æœ€æ–°å–å¾—
    renderVendorSelector();
    selectVendor(master.vendors[0].name);
  };

  // --- ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚³ã‚¢ ---
  function loadLocalOrders() {
    const saved = localStorage.getItem('orders_v2');
    orders = saved ? JSON.parse(saved) : {};
  }

  async function handleDateChange() {
    setSyncStatus('syncing', 'æ›´æ–°ä¸­...');
    loadLocalOrders(); 
    if(config.gasUrl) await pullFromCloud(); // æ—¥ä»˜ã‚’å¤‰ãˆãŸã‚‰å³ã‚¯ãƒ©ã‚¦ãƒ‰ç¢ºèª
    renderItems();
    if(document.getElementById('view-today').style.display !== 'none') renderTodaySummary();
  }

  async function pullFromCloud() {
    if(!config.gasUrl) return;
    const date = document.getElementById('dateInput').value;
    try {
      const res = await fetch(`${config.gasUrl}?date=${date}&storeId=${config.storeId}`);
      const result = await res.json();
      if(result.data && result.data !== "{}" && result.data !== "") {
        orders[date] = JSON.parse(result.data);
        localStorage.setItem('orders_v2', JSON.stringify(orders));
        setSyncStatus('online', 'CLOUD');
      } else {
        setSyncStatus('online', 'LOCAL (NO CLOUD DATA)');
      }
    } catch(e) {
      setSyncStatus('error', 'OFFLINE');
    }
  }

  async function syncToCloud() {
    if(!config.gasUrl) return;
    setSyncStatus('syncing', 'ä¿å­˜ä¸­...');
    const date = document.getElementById('dateInput').value;
    try {
      await fetch(config.gasUrl, {
        method: 'POST',
        body: JSON.stringify({
          date: date,
          storeId: config.storeId,
          data: JSON.stringify(orders[date] || {})
        })
      });
      setSyncStatus('online', 'CLOUD SAVED');
    } catch(e) {
      setSyncStatus('error', 'SAVE ERROR');
    }
  }

  // --- UIæç”» ---
  function renderVendorSelector() {
    const container = document.getElementById('vendorSelector');
    container.innerHTML = master.vendors.map(v => `
      <div class="vendor-chip ${v.name === currentVendor ? 'active' : ''}" onclick="selectVendor('${v.name}')">${v.name}</div>
    `).join('');
  }

  function selectVendor(name) {
    currentVendor = name;
    renderVendorSelector();
    document.getElementById('vendorTitle').innerText = `ğŸ¢ ${name} ã®ç™ºæ³¨`;
    renderItems();
  }

  function renderItems() {
    const date = document.getElementById('dateInput').value;
    const vendor = master.vendors.find(v => v.name === currentVendor);
    const container = document.getElementById('itemList');
    
    if(!vendor) return container.innerHTML = "";

    container.innerHTML = vendor.items.map(item => {
      const data = (orders[date]?.[currentVendor]?.[item.name]) || {qty:0, stock:0};
      const isShort = data.stock < item.ideal && data.qty === 0;

      return `
        <div class="item-card ${data.qty > 0 ? 'has-qty' : ''} ${isShort ? 'shortage' : ''}">
          <div class="item-info">
            <div class="name">${item.name}</div>
            <div class="meta">ç›®å®‰: ${item.ideal}${item.unit}</div>
            <div class="stock-input-wrap">
              åœ¨åº«: <input type="number" class="stock-field" value="${data.stock}" 
                onchange="updateVal('${item.name}', 'stock', this.value)"> ${item.unit}
            </div>
          </div>
          <div class="counter">
            <button class="btn-qty" onclick="changeQty('${item.name}', -1)">-</button>
            <div class="qty-display">${data.qty}</div>
            <button class="btn-qty" onclick="changeQty('${item.name}', 1)">+</button>
          </div>
        </div>
      `;
    }).join('');
  }

  function changeQty(itemName, delta) {
    const date = document.getElementById('dateInput').value;
    if(!orders[date]) orders[date] = {};
    if(!orders[date][currentVendor]) orders[date][currentVendor] = {};
    if(!orders[date][currentVendor][itemName]) orders[date][currentVendor][itemName] = {qty:0, stock:0};
    
    let current = orders[date][currentVendor][itemName].qty;
    orders[date][currentVendor][itemName].qty = Math.max(0, current + delta);
    
    saveAndSync();
    renderItems();
  }

  function updateVal(itemName, field, val) {
    const date = document.getElementById('dateInput').value;
    if(!orders[date]) orders[date] = {};
    if(!orders[date][currentVendor]) orders[date][currentVendor] = {};
    if(!orders[date][currentVendor][itemName]) orders[date][currentVendor][itemName] = {qty:0, stock:0};
    
    orders[date][currentVendor][itemName][field] = Number(val);
    saveAndSync();
    renderItems();
  }

  function saveAndSync() {
    localStorage.setItem('orders_v2', JSON.stringify(orders));
    clearTimeout(window.syncTimer);
    window.syncTimer = setTimeout(syncToCloud, 1500); // 1.5ç§’å¾Œ
  }

  // --- ã‚µãƒ–ç”»é¢ ---
  function renderTodaySummary() {
    const date = document.getElementById('dateInput').value;
    const dayData = orders[date] || {};
    let html = "";
    for(let v in dayData) {
      let items = Object.entries(dayData[v]).filter(([n, d]) => d.qty > 0);
      if(items.length > 0) {
        html += `<div style="margin-bottom:12px; border-bottom:1px solid #eee; padding-bottom:8px;">
          <b style="color:var(--primary)">â–  ${v}</b><br>
          ${items.map(([n, d]) => `ãƒ»${n} : ${d.qty}`).join('<br>')}
        </div>`;
      }
    }
    document.getElementById('todaySummary').innerHTML = html || "ç™ºæ³¨ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“";
  }

  function switchTab(tabId, el) {
    document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
    document.getElementById(`view-${tabId}`).style.display = 'block';
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
    if(tabId === 'today') renderTodaySummary();
  }

  function setSyncStatus(type, text) {
    const dot = document.getElementById('dot');
    const txt = document.getElementById('syncText');
    txt.innerText = text;
    dot.className = 'status-dot ' + (type === 'syncing' ? 'status-syncing' : (type === 'online' ? 'status-online' : ''));
  }

  function saveSettings() {
    config.gasUrl = document.getElementById('gasUrl').value;
    config.storeId = document.getElementById('storeId').value;
    localStorage.setItem('orderConfig_v2', JSON.stringify(config));
    alert('è¨­å®šå®Œäº†ï¼æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã€‚');
    pullFromCloud();
  }

  async function copySummary() {
    const text = document.getElementById('todaySummary').innerText;
    await navigator.clipboard.writeText(text);
    alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  }
</script>
</body>
</html>
