<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>発注アシスト Cloud</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
      --accent:#16a34a;
      --danger:#dc2626;
      --warn:#d97706;
      --shadow: 0 10px 30px rgba(17,24,39,.10);
      --r:18px;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    body{
      margin:0; font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg); color:var(--text);
      overscroll-behavior: none; /* iPadの引っ張り更新防止 */
    }
    header{
      position:sticky; top:0; z-index:20;
      padding:12px; background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px); border-bottom:1px solid var(--border);
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .chip{
      padding:6px 10px; border:1px solid var(--border);
      background: #fff; border-radius:999px; display:flex; gap:8px; align-items:center;
    }
    .tabs{display:grid; grid-template-columns: repeat(4, 1fr); gap:6px; margin-top:10px;}
    .tab{
      padding:10px; border-radius: 999px; cursor:pointer; text-align:center;
      font-weight:700; color: var(--muted); border:1px solid transparent;
    }
    .tab.active{background: rgba(34,197,94,.1); border-color: var(--accent); color: var(--accent)}
    
    main{padding:12px; max-width:1100px; margin:0 auto}
    .card{background:#fff; border-radius:var(--r); padding:16px; box-shadow:var(--shadow); margin-bottom:12px;}
    
    /* 商品行のスタイル */
    .itemRow{
      display:grid; grid-template-columns: 1fr auto; gap:12px;
      padding:12px; background: #f9fafb; border:1px solid var(--border);
      border-radius: 16px; margin-bottom:8px; align-items:center;
    }
    .itemRow.hasQty{ border-color: var(--accent); background: rgba(34,197,94,.05); }
    .itemRow.shortage{ border-color: var(--warn); background: rgba(245,158,11,.05); }

    .qtyInput, .stockInput{
      width:70px; text-align:center; padding:10px; border-radius:12px;
      border:1px solid var(--border); font-weight:900; font-size:16px;
    }
    
    .btn{
      padding:10px 16px; border-radius:12px; border:1px solid var(--border);
      background:#fff; font-weight:700; cursor:pointer;
    }
    .btn.primary{background: var(--accent); color:#fff; border:none}
    
    .status-badge{ font-size:12px; padding:2px 8px; border-radius:4px; font-weight:bold; }
    .status-ok{ background: #dcfce7; color: #166534; }
    .status-sync{ background: #fef9c3; color: #854d0e; }

    input[type="date"]{ border:none; font-weight:bold; font-size:16px; outline:none; }
  </style>
</head>
<body>

<header>
  <div class="row" style="justify-content:space-between">
    <div class="row">
      <b style="font-size:1.2em">発注アシスト</b>
      <div class="chip">
        <input type="date" id="dateInput" />
        <span id="syncStatus" class="status-badge status-ok">Local</span>
      </div>
    </div>
    <button class="btn primary" onclick="pullFromCloud()">最新を取得</button>
  </div>
  <div class="tabs">
    <div class="tab active" onclick="switchTab('vendors')">業者</div>
    <div class="tab" onclick="switchTab('today')">今日の発注</div>
    <div class="tab" onclick="switchTab('settings')">設定</div>
    <div class="tab" onclick="switchTab('history')">履歴</div>
  </div>
</header>

<main>
  <section id="view-vendors" class="view">
    <div style="display:grid; grid-template-columns: 280px 1fr; gap:15px;">
      <div id="vendorList" class="card"></div>
      <div class="card">
        <div id="itemHeader" style="margin-bottom:15px; display:flex; justify-content:space-between;">
          <h3 id="selectedVendorName">業者を選択してください</h3>
        </div>
        <div id="itemList"></div>
      </div>
    </div>
  </section>

  <section id="view-settings" class="view" style="display:none">
    <div class="card">
      <h3>クラウド同期設定</h3>
      <p style="font-size:13px; color:var(--muted)">Google Apps ScriptのURLを入力してください。</p>
      <input type="text" id="gasUrl" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid var(--border);" placeholder="https://script.google.com/macros/s/.../exec">
      <input type="text" id="storeId" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border);" placeholder="店舗名（例: MainStore）">
      <div style="margin-top:15px">
        <label><input type="checkbox" id="autoSync" checked> 自動保存を有効にする</label>
      </div>
      <button class="btn primary" style="margin-top:15px" onclick="saveSettings()">設定を保存</button>
    </div>
  </section>

  <section id="view-today" class="view" style="display:none">
    <div class="card">
      <h3>今日の発注リスト</h3>
      <div id="todaySummary"></div>
      <button class="btn" onclick="copySummary()">内容をコピー</button>
    </div>
  </section>
</main>

<script>
  // --- 状態管理 ---
  let orders = {}; // { date: { vendor: { item: { qty, stock } } } }
  let master = { vendors: [] };
  let currentVendor = "";
  let config = JSON.parse(localStorage.getItem('orderConfig') || '{"gasUrl":"","storeId":"","autoSync":true}');

  // --- 初期化 ---
  window.onload = async () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateInput').value = today;
    document.getElementById('gasUrl').value = config.gasUrl;
    document.getElementById('storeId').value = config.storeId;
    
    await loadMaster();
    loadLocalOrders();
    if(config.gasUrl) pullFromCloud();
    renderVendors();
  };

  async function loadMaster() {
    // 本来は外部JSON等から取得。今回はサンプル
    master.vendors = [
      {name: "大光", items: [{name: "バター", unit: "kg", ideal: 5}, {name: "牛乳", unit: "本", ideal: 10}]},
      {name: "高瀬", items: [{name: "キャベツ", unit: "玉", ideal: 3}, {name: "レタス", unit: "玉", ideal: 2}]}
    ];
  }

  function loadLocalOrders() {
    const saved = localStorage.getItem('orders');
    if(saved) orders = JSON.parse(saved);
  }

  // --- クラウド同期ロジック ---
  async function syncToCloud() {
    if(!config.gasUrl) return;
    setStatus('sync', '同期中...');
    
    const date = document.getElementById('dateInput').value;
    try {
      const res = await fetch(config.gasUrl, {
        method: 'POST',
        body: JSON.stringify({
          date: date,
          storeId: config.storeId,
          data: JSON.stringify(orders[date] || {})
        })
      });
      if(res.ok) setStatus('ok', 'Cloud OK');
    } catch(e) {
      setStatus('err', '同期失敗');
    }
  }

  async function pullFromCloud() {
    if(!config.gasUrl) return;
    const date = document.getElementById('dateInput').value;
    setStatus('sync', '取得中...');
    
    try {
      const res = await fetch(`${config.gasUrl}?date=${date}&storeId=${config.storeId}`);
      const result = await res.json();
      if(result.data && result.data !== "{}") {
        orders[date] = JSON.parse(result.data);
        localStorage.setItem('orders', JSON.stringify(orders));
        renderItems();
        setStatus('ok', 'Cloud同期済');
      } else {
        setStatus('ok', 'Cloudデータ無');
      }
    } catch(e) {
      setStatus('err', '取得失敗');
    }
  }

  // --- 描画ロジック ---
  function renderVendors() {
    const container = document.getElementById('vendorList');
    container.innerHTML = master.vendors.map(v => `
      <div class="tab" onclick="selectVendor('${v.name}')" id="v-${v.name}">${v.name}</div>
    `).join('');
  }

  function selectVendor(name) {
    currentVendor = name;
    document.querySelectorAll('#vendorList .tab').forEach(el => el.classList.remove('active'));
    document.getElementById(`v-${name}`).classList.add('active');
    document.getElementById('selectedVendorName').innerText = name;
    renderItems();
  }

  function renderItems() {
    const date = document.getElementById('dateInput').value;
    const vendor = master.vendors.find(v => v.name === currentVendor);
    if(!vendor) return;

    const container = document.getElementById('itemList');
    container.innerHTML = vendor.items.map(item => {
      const data = (orders[date] && orders[date][currentVendor] && orders[date][currentVendor][item.name]) || {qty:0, stock:0};
      const isShort = data.stock < item.ideal;
      
      return `
        <div class="itemRow ${data.qty > 0 ? 'hasQty' : ''} ${isShort ? 'shortage' : ''}">
          <div>
            <div style="font-weight:bold">${item.name}</div>
            <div style="font-size:12px; color:var(--muted)">目安: ${item.ideal}${item.unit}</div>
          </div>
          <div class="row">
            <div style="text-align:center">
              <div style="font-size:10px">在庫</div>
              <input type="number" class="stockInput" value="${data.stock}" onchange="updateVal('${item.name}', 'stock', this.value)">
            </div>
            <div style="text-align:center">
              <div style="font-size:10px">発注</div>
              <input type="number" class="qtyInput" value="${data.qty}" onchange="updateVal('${item.name}', 'qty', this.value)">
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function updateVal(itemName, field, val) {
    const date = document.getElementById('dateInput').value;
    if(!orders[date]) orders[date] = {};
    if(!orders[date][currentVendor]) orders[date][currentVendor] = {};
    if(!orders[date][currentVendor][itemName]) orders[date][currentVendor][itemName] = {qty:0, stock:0};
    
    orders[date][currentVendor][itemName][field] = Number(val);
    localStorage.setItem('orders', JSON.stringify(orders));
    
    if(config.autoSync) {
      clearTimeout(window.syncTimer);
      window.syncTimer = setTimeout(syncToCloud, 2000);
    }
    renderItems();
  }

  // --- ユーティリティ ---
  function setStatus(type, text) {
    const el = document.getElementById('syncStatus');
    el.innerText = text;
    el.className = `status-badge status-${type === 'ok' ? 'ok' : 'sync'}`;
  }

  function switchTab(tabId) {
    document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
    document.getElementById(`view-${tabId}`).style.display = 'block';
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    event.currentTarget.classList.add('active');
    if(tabId === 'today') renderTodaySummary();
  }

  function saveSettings() {
    config.gasUrl = document.getElementById('gasUrl').value;
    config.storeId = document.getElementById('storeId').value;
    config.autoSync = document.getElementById('autoSync').checked;
    localStorage.setItem('orderConfig', JSON.stringify(config));
    alert('設定を保存しました');
  }

  function renderTodaySummary() {
    const date = document.getElementById('dateInput').value;
    const dayData = orders[date] || {};
    let html = "";
    for(let v in dayData) {
      html += `<h4>【${v}】</h4>`;
      for(let i in dayData[v]) {
        if(dayData[v][i].qty > 0) html += `<p>${i}: ${dayData[v][i].qty}</p>`;
      }
    }
    document.getElementById('todaySummary').innerHTML = html || "発注データはありません";
  }
</script>
</body>
</html>
