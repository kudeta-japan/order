<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Áô∫Ê≥®„Ç¢„Ç∑„Çπ„Éà Pro (‰øÆÊ≠£Áâà)</title>
  <style>
    :root {
      --primary: #16a34a; --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; --muted: #6b7280; --warn: #f59e0b;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); padding-bottom: 80px; overscroll-behavior: none; }
    header {
      position: sticky; top: 0; z-index: 100; background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px); padding: 12px 16px; border-bottom: 1px solid #e5e7eb;
      display: flex; justify-content: space-between; align-items: center;
    }
    .date-badge { background: #fff; padding: 6px 12px; border-radius: 999px; border: 1px solid #ddd; display: flex; align-items: center; }
    #dateInput { border: none; font-size: 1em; font-weight: bold; outline: none; background: transparent; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; margin-right: 5px; }
    .online { background: var(--primary); }
    .syncing { background: var(--warn); animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0.3; } }

    main { padding: 12px; max-width: 800px; margin: 0 auto; }
    .vendor-selector { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 16px; }
    .vendor-chip { white-space: nowrap; padding: 10px 20px; background: #fff; border-radius: 999px; border: 1px solid #e5e7eb; font-weight: bold; color: var(--muted); cursor: pointer; }
    .vendor-chip.active { background: var(--primary); color: #fff; border-color: var(--primary); }

    .item-card { background: var(--card); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: grid; grid-template-columns: 1fr auto; align-items: center; }
    .item-card.has-qty { border-left: 6px solid var(--primary); }
    .item-info .name { font-weight: 800; font-size: 1.1em; }
    .counter { display: flex; align-items: center; gap: 8px; background: #f9fafb; padding: 6px; border-radius: 12px; }
    .btn-qty { width: 44px; height: 44px; border-radius: 10px; border: none; background: #fff; font-size: 1.5em; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; }
    .qty-display { width: 40px; text-align: center; font-size: 1.2em; font-weight: 900; }

    nav { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 1px solid #e5e7eb; display: grid; grid-template-columns: repeat(3, 1fr); padding: 10px 0 25px; }
    .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--muted); cursor: pointer; font-size: 0.8em; font-weight: bold; }
    .nav-item.active { color: var(--primary); }
  </style>
</head>
<body>

<header>
  <div class="date-badge">
    <input type="date" id="dateInput">
  </div>
  <div style="display: flex; align-items: center; font-size: 0.8em; font-weight: bold;">
    <span class="status-dot" id="dot"></span>
    <span id="syncText">READY</span>
  </div>
</header>

<main>
  <div id="view-vendors" class="view">
    <div class="vendor-selector" id="vendorSelector"></div>
    <div id="itemList"></div>
  </div>

  <div id="view-today" class="view" style="display:none">
    <div style="background:#fff; padding:16px; border-radius:16px;" id="todaySummary"></div>
  </div>

  <div id="view-settings" class="view" style="display:none">
    <div style="background:#fff; padding:16px; border-radius:16px;">
      <label style="font-size: 0.8em; font-weight: bold;">GAS Web„Ç¢„Éó„É™URL</label>
      <input type="text" id="gasUrl" style="width:100%; padding:10px; margin-top:5px; border-radius:8px; border:1px solid #ddd;">
      <button onclick="saveSettings()" style="width:100%; margin-top:15px; padding:12px; background:var(--text); color:#fff; border-radius:8px; border:none; font-weight:bold;">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
    </div>
  </div>
</main>

<nav>
  <div class="nav-item active" onclick="switchTab('vendors', this)"><span>üõí Áô∫Ê≥®</span></div>
  <div class="nav-item" onclick="switchTab('today', this)"><span>üìã „É™„Çπ„Éà</span></div>
  <div class="nav-item" onclick="switchTab('settings', this)"><span>‚öôÔ∏è Ë®≠ÂÆö</span></div>
</nav>

<script>
  let orders = {}; 
  let currentVendor = "";
  let master = {
    vendors: [
      {name: "Â§ßÂÖâ", items: [{name: "„Éê„Çø„Éº", unit: "kg"}, {name: "Áâõ‰π≥", unit: "Êú¨"}]},
      {name: "È´òÁÄ¨", items: [{name: "„Ç≠„É£„Éô„ÉÑ", unit: "Áéâ"}, {name: "„É¨„Çø„Çπ", unit: "Áéâ"}]},
      {name: "ÂÆâÁî∞ÈùíÊûú", items: [{name: "Áéâ„Å≠„Åé", unit: "kg"}]}
    ]
  };

  let config = JSON.parse(localStorage.getItem('orderConfig_v3') || '{"gasUrl":"","storeId":"default"}');

  // --- ÂàùÊúüËµ∑Âãï ---
  window.onload = async () => {
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('dateInput');
    dateInput.value = today;
    document.getElementById('gasUrl').value = config.gasUrl;

    // Êó•‰ªòÂ§âÊõ¥„Ç§„Éô„É≥„Éà„Çí„Éê„Ç§„É≥„Éâ
    dateInput.addEventListener('change', handleDateChange);

    loadLocalOrders();
    if(config.gasUrl) await pullFromCloud(); 
    renderVendorSelector();
    selectVendor(master.vendors[0].name);
  };

  // --- Êó•‰ªòÂ§âÊõ¥ÊôÇ„ÅÆ„Ç≥„Ç¢„É≠„Ç∏„ÉÉ„ÇØ („Åì„Åì„Åå‰øÆÊ≠£„ÅÆËÇù) ---
  async function handleDateChange() {
    setSyncStatus('syncing', '„Éá„Éº„ÇøË™≠Ëæº‰∏≠...');
    const newDate = document.getElementById('dateInput').value;
    
    // 1. „Åæ„Åö„É°„É¢„É™‰∏ä„ÅÆ orders „Åß„ÅØ„Å™„Åè„ÄÅÊúÄÊñ∞„ÅÆ„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÇíË™≠„ÅøÁõ¥„Åô
    loadLocalOrders();
    
    // 2. „ÇØ„É©„Ç¶„ÉâË®≠ÂÆö„Åå„ÅÇ„Çã„Å™„Çâ„ÄÅ„Åù„ÅÆÊó•‰ªò„ÅÆ„Éá„Éº„Çø„ÇíÂèñÂæó
    if(config.gasUrl) {
      await pullFromCloud(); 
    }
    
    // 3. ÊèèÁîª
    renderItems();
    if(document.getElementById('view-today').style.display !== 'none') renderTodaySummary();
  }

  function loadLocalOrders() {
    const saved = localStorage.getItem('orders_v3');
    orders = saved ? JSON.parse(saved) : {};
  }

  async function pullFromCloud() {
    if(!config.gasUrl) return;
    const date = document.getElementById('dateInput').value;
    try {
      const res = await fetch(`${config.gasUrl}?date=${date}&storeId=${config.storeId}`);
      const result = await res.json();
      
      // ÈáçË¶ÅÔºö„ÇØ„É©„Ç¶„Éâ„Å´„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„Åø„Éû„Éº„Ç∏„ÄÇ„Å™„ÅÑÂ†¥Âêà„ÅØ‰∏äÊõ∏„Åç„Åõ„Åö„É≠„Éº„Ç´„É´„ÇíÁ∂≠ÊåÅ
      if(result.data && result.data !== "{}" && result.data !== "") {
        orders[date] = JSON.parse(result.data);
        localStorage.setItem('orders_v3', JSON.stringify(orders));
        setSyncStatus('online', 'ÊúÄÊñ∞ÂêåÊúüÊ∏à');
      } else {
        setSyncStatus('online', 'Êñ∞Ë¶è„Éá„Éº„ÇøÂÖ•ÂäõÂèØ');
      }
    } catch(e) {
      setSyncStatus('error', '„Ç™„Éï„É©„Ç§„É≥Ë°®Á§∫');
    }
    renderItems();
  }

  async function syncToCloud() {
    if(!config.gasUrl) return;
    setSyncStatus('syncing', '‰øùÂ≠ò‰∏≠...');
    const date = document.getElementById('dateInput').value;
    try {
      await fetch(config.gasUrl, {
        method: 'POST',
        body: JSON.stringify({
          date: date, storeId: config.storeId,
          data: JSON.stringify(orders[date] || {})
        })
      });
      setSyncStatus('online', '‰øùÂ≠òÂÆå‰∫Ü');
    } catch(e) {
      setSyncStatus('error', '‰øùÂ≠òÂ§±Êïó');
    }
  }

  // --- ÊèèÁîª„ÉªÊìç‰Ωú ---
  function renderVendorSelector() {
    const container = document.getElementById('vendorSelector');
    container.innerHTML = master.vendors.map(v => `
      <div class="vendor-chip ${v.name === currentVendor ? 'active' : ''}" onclick="selectVendor('${v.name}')">${v.name}</div>
    `).join('');
  }

  function selectVendor(name) {
    currentVendor = name;
    renderVendorSelector();
    renderItems();
  }

  function renderItems() {
    const date = document.getElementById('dateInput').value;
    const vendor = master.vendors.find(v => v.name === currentVendor);
    const container = document.getElementById('itemList');
    if(!vendor) return;

    container.innerHTML = vendor.items.map(item => {
      const data = (orders[date]?.[currentVendor]?.[item.name]) || {qty:0, stock:0};
      return `
        <div class="item-card ${data.qty > 0 ? 'has-qty' : ''}">
          <div class="item-info">
            <div class="name">${item.name}</div>
            <div style="font-size:0.8em; color:var(--muted)">Âçò‰Ωç: ${item.unit}</div>
          </div>
          <div class="counter">
            <button class="btn-qty" onclick="changeQty('${item.name}', -1)">-</button>
            <div class="qty-display">${data.qty}</div>
            <button class="btn-qty" onclick="changeQty('${item.name}', 1)">+</button>
          </div>
        </div>
      `;
    }).join('');
  }

  function changeQty(itemName, delta) {
    const date = document.getElementById('dateInput').value;
    if(!orders[date]) orders[date] = {};
    if(!orders[date][currentVendor]) orders[date][currentVendor] = {};
    if(!orders[date][currentVendor][itemName]) orders[date][currentVendor][itemName] = {qty:0, stock:0};
    
    orders[date][currentVendor][itemName].qty = Math.max(0, orders[date][currentVendor][itemName].qty + delta);
    
    // ‰øùÂ≠ò„Å®ÂêåÊúü
    localStorage.setItem('orders_v3', JSON.stringify(orders));
    renderItems();
    clearTimeout(window.syncTimer);
    window.syncTimer = setTimeout(syncToCloud, 2000);
  }

  function switchTab(tabId, el) {
    document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
    document.getElementById(`view-${tabId}`).style.display = 'block';
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
    if(tabId === 'today') renderTodaySummary();
  }

  function renderTodaySummary() {
    const date = document.getElementById('dateInput').value;
    const dayData = orders[date] || {};
    let html = `<h3>${date} „ÅÆÁô∫Ê≥®</h3>`;
    for(let v in dayData) {
      let items = Object.entries(dayData[v]).filter(([n, d]) => d.qty > 0);
      if(items.length > 0) {
        html += `<p><b>‚ñ† ${v}</b><br>${items.map(([n, d]) => `„Éª${n}: ${d.qty}`).join('<br>')}</p>`;
      }
    }
    document.getElementById('todaySummary').innerHTML = html || "Áô∫Ê≥®„Å™„Åó";
  }

  function setSyncStatus(type, text) {
    const dot = document.getElementById('dot');
    const txt = document.getElementById('syncText');
    txt.innerText = text;
    dot.className = 'status-dot ' + (type === 'syncing' ? 'syncing' : (type === 'online' ? 'online' : ''));
  }

  function saveSettings() {
    config.gasUrl = document.getElementById('gasUrl').value;
    localStorage.setItem('orderConfig_v3', JSON.stringify(config));
    alert('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ');
    pullFromCloud();
  }
</script>
</body>
</html>
