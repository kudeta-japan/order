<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>ç™ºæ³¨ã‚¢ã‚·ã‚¹ãƒˆ Cloud Biz</title>
  <style>
    :root {
      --primary: #2563eb; --accent: #16a34a; --bg: #f8fafc;
      --card: #ffffff; --text: #1e293b; --muted: #64748b;
      --border: #e2e8f0; --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; font-family: 'Segoe UI', Meiryo, sans-serif;
      background: var(--bg); color: var(--text); line-height: 1.5;
    }

    /* --- Layout --- */
    header {
      position: sticky; top: 0; z-index: 100;
      background: #fff; padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow);
    }
    .main-layout {
      display: grid; grid-template-columns: 200px 1fr; height: calc(100vh - 130px);
    }
    @media (max-width: 768px) {
      .main-layout { grid-template-columns: 1fr; }
      .sidebar { display: none; } /* ã‚¹ãƒãƒ›æ™‚ã¯ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼å½¢å¼ã«åˆ‡ã‚Šæ›¿ãˆå¯ */
    }

    /* --- UI Components --- */
    .sidebar { background: #fff; border-right: 1px solid var(--border); padding: 10px; overflow-y: auto; }
    .content { padding: 16px; overflow-y: auto; background: var(--bg); }
    
    .vendor-item {
      padding: 12px 16px; border-radius: 8px; cursor: pointer;
      font-weight: bold; margin-bottom: 4px; transition: 0.2s;
      color: var(--muted); border: 1px solid transparent;
    }
    .vendor-item.active {
      background: #eff6ff; color: var(--primary); border-color: var(--primary);
    }

    .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px; }
    .item-card {
      background: #fff; padding: 16px; border-radius: 12px;
      border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex; justify-content: space-between; align-items: center;
    }
    .item-card.has-qty { border-color: var(--accent); background: #f0fdf4; }

    .qty-ctrl { display: flex; align-items: center; gap: 10px; }
    .btn-qty {
      width: 40px; height: 40px; border-radius: 8px; border: 1px solid #ddd;
      background: #fff; font-size: 1.2em; cursor: pointer; font-weight: bold;
    }
    .qty-num { font-size: 1.3em; font-weight: 800; width: 30px; text-align: center; }

    /* --- Common --- */
    .status-badge { font-size: 11px; padding: 4px 8px; border-radius: 4px; font-weight: 800; }
    .syncing { background: #fef9c3; color: #854d0e; }
    .online { background: #dcfce7; color: #166534; }

    nav {
      position: fixed; bottom: 0; width: 100%; background: #fff;
      display: grid; grid-template-columns: repeat(3, 1fr);
      padding: 10px 0 20px; border-top: 1px solid var(--border);
    }
    .nav-btn { text-align: center; font-size: 12px; font-weight: bold; color: var(--muted); cursor: pointer; }
    .nav-btn.active { color: var(--primary); }

    .input-group { margin-bottom: 15px; }
    .input-group label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; }
    input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; }
  </style>
</head>
<body>

<header>
  <div style="display:flex; flex-direction:column;">
    <input type="date" id="dateInput" style="font-weight:bold; border:none; padding:0; width:auto;">
    <span id="syncStatus" class="status-badge online">READY</span>
  </div>
  <div style="text-align:right">
    <label style="font-size:10px; display:block">æ‹…å½“è€…</label>
    <select id="userSelect" style="width:120px; padding:4px; font-size:12px;"></select>
  </div>
</header>

<main>
  <section id="view-main" class="view main-layout">
    <div class="sidebar" id="vendorList"></div>
    <div class="content">
      <h2 id="currentVendorName" style="margin-top:0">æ¥­è€…ã‚’é¸æŠ</h2>
      <div id="itemList" class="item-grid"></div>
    </div>
  </section>

  <section id="view-settings" class="view" style="display:none; padding:20px;">
    <div style="max-width:500px; margin:0 auto; background:#fff; padding:20px; border-radius:12px;">
      <h3>ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h3>
      <div class="input-group">
        <label>GAS Webã‚¢ãƒ—ãƒªURL</label>
        <input type="text" id="gasUrl" placeholder="https://script.google.com/...">
      </div>
      <div class="input-group">
        <label>ã‚¹ã‚¿ãƒƒãƒ•åï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
        <input type="text" id="staffList" placeholder="ç”°ä¸­, ä½è—¤, éˆ´æœ¨">
      </div>
      <button onclick="saveSettings()" style="width:100%; background:var(--primary); color:#fff; padding:12px; border:none; border-radius:6px; font-weight:bold;">ä¿å­˜ã—ã¦é©ç”¨</button>
    </div>
  </section>

  <section id="view-list" class="view" style="display:none; padding:20px;">
    <div id="summaryContent" style="max-width:600px; margin:0 auto; background:#fff; padding:20px; border-radius:12px;"></div>
  </section>
</main>

<nav>
  <div class="nav-btn active" onclick="switchTab('main', this)">ğŸ›’ ç™ºæ³¨</div>
  <div class="nav-btn" onclick="switchTab('list', this)">ğŸ“‹ ç¢ºèª</div>
  <div class="nav-btn" onclick="switchTab('settings', this)">âš™ï¸ è¨­å®š</div>
</nav>

<script>
  let orders = {};
  let currentVendor = "";
  let master = {
    vendors: [
      {name: "å¤§å…‰", items: [{name: "ãƒã‚¿ãƒ¼", unit: "kg"}, {name: "ç‰›ä¹³", unit: "æœ¬"}]},
      {name: "é«˜ç€¬", items: [{name: "ã‚­ãƒ£ãƒ™ãƒ„", unit: "ç‰"}, {name: "ãƒ¬ã‚¿ã‚¹", unit: "ç‰"}]},
      {name: "å®‰ç”°é’æœ", items: [{name: "ç‰ã­ã", unit: "kg"}]}
    ]
  };

  let config = JSON.parse(localStorage.getItem('orderConfig_v4') || '{"gasUrl":"","staff":"æ‹…å½“è€…æœªè¨­å®š"}');

  window.onload = async () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateInput').value = today;
    document.getElementById('gasUrl').value = config.gasUrl;
    document.getElementById('staffList').value = config.staff;
    
    updateUserSelect();
    document.getElementById('dateInput').addEventListener('change', handleDateChange);
    
    await loadInitialData();
    renderVendors();
  };

  // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚³ã‚¢ ---
  async function loadInitialData() {
    setSyncStatus('syncing', 'ãƒ‡ãƒ¼ã‚¿èª­è¾¼ä¸­...');
    const saved = localStorage.getItem('orders_v4');
    if(saved) orders = JSON.parse(saved);
    
    if(config.gasUrl) {
      await pullFromCloud(); // ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰æœ€æ–°ã‚’å–å¾—
    }
    setSyncStatus('online', 'åŒæœŸæ¸ˆã¿');
  }

  async function handleDateChange() {
    setSyncStatus('syncing', 'æ—¥ä»˜å¤‰æ›´ä¸­...');
    // æ—¥ä»˜å¤‰æ›´æ™‚ã¯ã¾ãšã‚¯ãƒ©ã‚¦ãƒ‰ã‚’ã€Œå¾…æ©Ÿã€ã—ã¦å–å¾—
    await pullFromCloud();
    renderItems();
  }

  async function pullFromCloud() {
    const date = document.getElementById('dateInput').value;
    if(!config.gasUrl) return;
    try {
      const res = await fetch(`${config.gasUrl}?date=${date}&storeId=default`);
      const result = await res.json();
      if(result.data && result.data !== "{}") {
        orders[date] = JSON.parse(result.data);
        localStorage.setItem('orders_v4', JSON.stringify(orders));
      } else {
        // ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãƒ¡ãƒ¢ãƒªã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆä¸Šæ›¸ãã¯ã—ãªã„ï¼‰
        if(!orders[date]) orders[date] = {};
      }
    } catch(e) { console.error("Cloud Error", e); }
    setSyncStatus('online', 'ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸæ¸ˆ');
  }

  async function syncToCloud() {
    const date = document.getElementById('dateInput').value;
    if(!config.gasUrl || !orders[date]) return;
    setSyncStatus('syncing', 'ä¿å­˜ä¸­...');
    try {
      await fetch(config.gasUrl, {
        method: 'POST',
        body: JSON.stringify({
          date: date,
          data: JSON.stringify(orders[date]),
          user: document.getElementById('userSelect').value
        })
      });
      setSyncStatus('online', 'ä¿å­˜å®Œäº†');
    } catch(e) { setSyncStatus('online', 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜'); }
  }

  // --- UIåˆ¶å¾¡ ---
  function renderVendors() {
    const container = document.getElementById('vendorList');
    container.innerHTML = master.vendors.map(v => `
      <div class="vendor-item ${v.name === currentVendor ? 'active' : ''}" onclick="selectVendor('${v.name}')">
        ${v.name}
      </div>
    `).join('');
  }

  function selectVendor(name) {
    currentVendor = name;
    document.getElementById('currentVendorName').innerText = name;
    renderVendors();
    renderItems();
  }

  function renderItems() {
    const date = document.getElementById('dateInput').value;
    const vendor = master.vendors.find(v => v.name === currentVendor);
    const container = document.getElementById('itemList');
    if(!vendor) return container.innerHTML = "æ¥­è€…ã‚’é¸æŠã—ã¦ãã ã•ã„";

    container.innerHTML = vendor.items.map(item => {
      const qty = orders[date]?.[currentVendor]?.[item.name]?.qty || 0;
      return `
        <div class="item-card ${qty > 0 ? 'has-qty' : ''}">
          <div>
            <div style="font-weight:bold; font-size:1.1em;">${item.name}</div>
            <div style="color:var(--muted); font-size:12px;">å˜ä½: ${item.unit}</div>
          </div>
          <div class="qty-ctrl">
            <button class="btn-qty" onclick="changeQty('${item.name}', -1)">-</button>
            <div class="qty-num">${qty}</div>
            <button class="btn-qty" onclick="changeQty('${item.name}', 1)">+</button>
          </div>
        </div>
      `;
    }).join('');
  }

  function changeQty(itemName, delta) {
    const date = document.getElementById('dateInput').value;
    if(!orders[date]) orders[date] = {};
    if(!orders[date][currentVendor]) orders[date][currentVendor] = {};
    if(!orders[date][currentVendor][itemName]) orders[date][currentVendor][itemName] = {qty:0};

    orders[date][currentVendor][itemName].qty = Math.max(0, orders[date][currentVendor][itemName].qty + delta);
    
    localStorage.setItem('orders_v4', JSON.stringify(orders));
    renderItems();
    
    clearTimeout(window.syncTimer);
    window.syncTimer = setTimeout(syncToCloud, 2000);
  }

  function updateUserSelect() {
    const list = config.staff.split(',').map(s => s.trim());
    const select = document.getElementById('userSelect');
    select.innerHTML = list.map(s => `<option value="${s}">${s}</option>`).join('');
  }

  function saveSettings() {
    config.gasUrl = document.getElementById('gasUrl').value;
    config.staff = document.getElementById('staffList').value;
    localStorage.setItem('orderConfig_v4', JSON.stringify(config));
    updateUserSelect();
    alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
  }

  function switchTab(tabId, el) {
    document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
    document.getElementById(`view-${tabId}`).style.display = (tabId === 'main') ? 'grid' : 'block';
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    if(tabId === 'list') renderSummary();
  }

  function renderSummary() {
    const date = document.getElementById('dateInput').value;
    const dayData = orders[date] || {};
    let html = `<h2>${date} ã®ç™ºæ³¨å†…å®¹</h2>`;
    let hasData = false;
    for(let v in dayData) {
      const items = Object.entries(dayData[v]).filter(([n, d]) => d.qty > 0);
      if(items.length > 0) {
        hasData = true;
        html += `<div style="margin-bottom:20px; border-left:4px solid var(--primary); padding-left:15px;">
          <h3 style="margin:0; color:var(--primary);">${v}</h3>
          ${items.map(([n, d]) => `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:5px 0;"><span>${n}</span><b>${d.qty}</b></div>`).join('')}
        </div>`;
      }
    }
    document.getElementById('summaryContent').innerHTML = hasData ? html : "ç™ºæ³¨ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
  }

  function setSyncStatus(type, text) {
    const el = document.getElementById('syncStatus');
    el.innerText = text;
    el.className = `status-badge ${type}`;
  }
</script>
</body>
</html>
