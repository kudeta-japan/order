<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#ffffff" />
  <title>発注アシスト</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icons/icon-192.png" />
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --card2:#f9fafb;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
      --accent:#16a34a;
      --danger:#dc2626;
      --warn:#d97706;
      --shadow: 0 10px 30px rgba(17,24,39,.10);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", "Hiragino Sans", "Yu Gothic", sans-serif;
      background: radial-gradient(1100px 600px at 20% -10%, rgba(34,197,94,.10), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(59,130,246,.08), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:20;
      padding:14px 14px 10px;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(148,163,184,.15);
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .title{font-weight:800; letter-spacing:.02em; font-size:18px}
    .chip{
      padding:8px 10px; border:1px solid rgba(148,163,184,.18);
      background: rgba(255,255,255,.92);
      border-radius:999px;
      display:flex; gap:8px; align-items:center;
    }
    input, button, textarea, select{
      font: inherit;
      color: inherit;
    }
    .date{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      outline:none;
    }
    .iconBtn{
      width:36px; height:36px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:900;
      line-height:1;
      display:flex; align-items:center; justify-content:center;
      user-select:none;
    }
    .iconBtn:active{transform: translateY(1px)}

    .tabs{
      display:grid; grid-template-columns: repeat(4, 1fr);
      gap:8px; margin-top:10px;
    }
    .tab{
      border:1px solid rgba(148,163,184,.18);
      background: rgba(255,255,255,.85);
      padding:10px 10px;
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
      text-align:center;
      font-weight:700;
      color: var(--muted);
    }
    .tab.active{background: rgba(34,197,94,.14); border-color: rgba(34,197,94,.35); color: var(--text)}

    main{padding:14px; max-width:1050px; margin:0 auto}

    .grid{display:grid; gap:12px}
    .grid.cols2{grid-template-columns: 1fr}
    @media (min-width: 860px){.grid.cols2{grid-template-columns: 360px 1fr}}

    .card{
      background: rgba(255,255,255,.95);
      border:1px solid rgba(148,163,184,.12);
      border-radius: var(--r);
      padding:12px;
      box-shadow: var(--shadow);
    }
    .card h2{margin:0 0 8px; font-size:16px}
    .muted{color:var(--muted)}

    .btn{
      border:1px solid rgba(148,163,184,.18);
      background: rgba(255,255,255,.85);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      user-select:none;
      font-weight:700;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{background: rgba(34,197,94,.16); border-color: rgba(34,197,94,.40)}
    .btn.danger{background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.35)}
    .btn.warn{background: rgba(245,158,11,.14); border-color: rgba(245,158,11,.35)}
    .btn.small{padding:8px 10px; border-radius:12px; font-weight:700}

    .list{display:flex; flex-direction:column; gap:10px}
    .vendorItem{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
      padding:12px;
      background: rgba(249,250,251,.95);
      border:1px solid rgba(148,163,184,.12);
      border-radius: 16px;
      cursor:pointer;
    }
    .vendorItem .name{font-weight:800}
    .badge{font-size:12px; padding:5px 8px; border-radius:999px; border:1px solid rgba(148,163,184,.18); color:var(--muted)}
    .badge.ok{border-color: rgba(34,197,94,.35); color: rgba(167,243,208,.95)}

    .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:8px 0 12px}
    .search{
      flex:1;
      min-width: 220px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(255,255,255,.85);
      outline:none;
    }

    .itemRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      padding:10px;
      background: rgba(249,250,251,.95);
      border:1px solid rgba(148,163,184,.10);
      border-radius: 16px;
    }
    .itemName{font-weight:800}
    .itemMeta{font-size:12px; color:var(--muted); margin-top:2px}

    .qtyBox{display:flex; align-items:center; gap:8px}
    .qtyBtn{
      width:40px; height:40px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(255,255,255,.85);
      font-size:18px;
      font-weight:900;
      cursor:pointer;
    }
    .qtyInput{
      width:72px;
      text-align:center;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(255,255,255,.85);
      outline:none;
      font-weight:900;
    }
    .pill{
      font-size:12px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(249,250,251,.90);
      color:var(--muted);
      white-space:nowrap;
    }

    .split{display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap}
    .hr{height:1px; background: rgba(148,163,184,.12); margin:12px 0}

    textarea{
      width:100%; min-height:140px;
      border-radius: 16px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(255,255,255,.85);
      padding:12px;
      outline:none;
      color: var(--text);
    }

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px;
      padding:10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.95);
      border:1px solid rgba(148,163,184,.18);
      color: var(--text);
      box-shadow: var(--shadow);
      opacity:0; pointer-events:none;
      transition: opacity .15s ease;
      z-index:50;
    }
    .toast.show{opacity:1}

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body>
  <header>
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <div class="title">発注アシスト</div>
        <div class="chip" title="日付ごとに保存されます">
          <span class="muted">日付</span>
          <button class="iconBtn" id="prevDayBtn" title="前日">‹</button>
          <input id="date" class="date" type="date" />
          <button class="iconBtn" id="nextDayBtn" title="翌日">›</button>
          <button class="btn small" id="todayBtn" title="今日に戻す">今日</button>
        </div>
        <div class="chip" title="入力すると自動で保存されます">
          <span class="muted">保存</span>
          <span id="saveState" class="badge ok">OK</span>
        </div>
      </div>
      <div class="row">
        <button class="btn small" id="installBtn" style="display:none">ホーム画面に追加</button>
      </div>
    </div>

    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="vendors">業者</div>
      <div class="tab" data-tab="today">今日の発注</div>
      <div class="tab" data-tab="history">履歴</div>
      <div class="tab" data-tab="settings">設定</div>
    </div>
  </header>

  <main>
    <section id="view-vendors" class="view">
      <div class="grid cols2">
        <div class="card">
          <h2>業者</h2>
          <div class="muted" style="margin-bottom:10px">タップ → 商品一覧 → 数量入力</div>
          <div id="vendorList" class="list"></div>
        </div>

        <div class="card">
          <div class="split">
            <h2 id="vendorTitle">商品</h2>
            <div class="row">
              <button class="btn small" id="clearVendorBtn">この業者を0に</button>
              <button class="btn small primary" id="toTodayBtn">今日の発注へ</button>
            </div>
          </div>
          <div class="toolbar">
            <input id="itemSearch" class="search" placeholder="商品検索（例：バター、牛乳…）" />
            <button class="btn small" id="addItemBtn">＋商品追加</button>
          </div>
          <div id="itemList" class="list"></div>
          <div class="muted" style="margin-top:10px; font-size:12px">※ 入力は自動保存（このiPad内）／複数端末で共有したい場合は「同期版」へ拡張できます</div>
        </div>
      </div>
    </section>

    <section id="view-today" class="view" style="display:none">
      <div class="card">
        <div class="split">
          <h2>今日の発注</h2>
          <div class="row">
            <button class="btn small" id="copyAllBtn">全部コピー</button>
            <button class="btn small" id="csvAllBtn">CSV出力</button>
            <button class="btn small danger" id="clearDayBtn">今日を全部0に</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="todaySummary" class="list"></div>
      </div>
    </section>

    <section id="view-history" class="view" style="display:none">
      <div class="card">
        <div class="split">
          <h2>履歴</h2>
          <button class="btn small danger" id="wipeAllBtn">全データ削除</button>
        </div>
        <div class="muted" style="margin:8px 0 12px">日付をタップすると読み込みます。</div>
        <div id="historyList" class="list"></div>
      </div>
    </section>

    <section id="view-settings" class="view" style="display:none">
      <div class="card">
        <h2>設定</h2>
        <div class="muted" style="margin-bottom:10px">
          マスター（業者・商品一覧）は端末内に保存されます。
          追加した商品も含めて「書き出し」できます。
        </div>
        <div class="row" style="gap:12px; margin-bottom:12px">
          <button class="btn" id="exportMasterBtn">マスターを書き出し（JSON）</button>
          <label class="btn" style="cursor:pointer">
            マスターを読み込み（JSON）
            <input type="file" id="importMaster" accept="application/json" style="display:none" />
          </label>
          <button class="btn warn" id="resetMasterBtn">初期マスターに戻す</button>
        </div>
        <div class="hr"></div>
        <h2 style="margin-top:0">同期版（次の一手）</h2>
        <div class="muted">
          「誰が」「いつ」「どれを発注したか」や、複数iPad/スマホで共有をやりたくなったら、
          Firebase / Supabase でログイン＋同期を追加できます。
          まずはこの版で現場の流れを固めるのが一番速いです。
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast">OK</div>

  <script>
  // ---------- helpers ----------
  const $ = (q) => document.querySelector(q);
  const $$ = (q) => Array.from(document.querySelectorAll(q));

  function localISODate(d=new Date()){
    // local date as YYYY-MM-DD (no UTC drift)
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function addDays(dateStr, delta){
    const parts = String(dateStr||"").split("-");
    const y = Number(parts[0]||0);
    const m = Number(parts[1]||1);
    const d = Number(parts[2]||1);
    const dt = new Date(y, m-1, d);
    dt.setDate(dt.getDate() + Number(delta||0));
    return localISODate(dt);
  }


  function toast(msg){
    const t = $('#toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 1200);
  }

  function downloadText(filename, text){
    const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    setTimeout(() => URL.revokeObjectURL(a.href), 800);
  }

  function downloadCSV(filename, rows){
    const esc = (v) => {
      const s = String(v ?? '');
      if (/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
      return s;
    };
    const csv = rows.map(r => r.map(esc).join(',')).join('\n');
    downloadText(filename, csv);
  }

  async function copyToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      toast('コピーしました');
    }catch(e){
      // fallback
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      toast('コピーしました');
    }
  }

  // ---------- vendor channels ----------
// channel: 'infomart' | 'web' | 'line'
const DEFAULT_VENDOR_CHANNEL = {
  '大光': 'infomart',
  '高瀬': 'infomart',
  'toho': 'web',
  'TOHO': 'web',
  'マルト': 'web',
  'めいらく': 'web',
  '安田青果': 'line',
  'トキノ屋': 'line',
};

function vendorChannel(name){
  const v = master?.vendors?.find(x => x.name === name);
  return (v && v.channel) ? v.channel : (DEFAULT_VENDOR_CHANNEL[name] || 'web');
}

function channelLabel(ch){
  return ch === 'infomart' ? 'Infomart' : ch === 'line' ? 'LINE' : 'WEB';
}

// ---------- storage keys ----------
  const KEY_MASTER = 'orderAssist.master.v1';
  const KEY_ORDERS = 'orderAssist.orders.v1'; // {date: {vendor: {itemName: {qty, unit, memo}}}}

  const saveStateEl = $('#saveState');
  let saveTimer = null;
  function markSaving(){
    saveStateEl.textContent = '保存中…';
    saveStateEl.classList.remove('ok');
  }
  function markSaved(){
    saveStateEl.textContent = 'OK';
    saveStateEl.classList.add('ok');
  }

  function getMaster(){
    const raw = localStorage.getItem(KEY_MASTER);
    if(!raw) return null;
    try{ return JSON.parse(raw); }catch(e){ return null; }
  }
  function setMaster(master){
    localStorage.setItem(KEY_MASTER, JSON.stringify(master));
  }

  function getOrders(){
    const raw = localStorage.getItem(KEY_ORDERS);
    if(!raw) return {};
    try{ return JSON.parse(raw); }catch(e){ return {}; }
  }
  function setOrders(orders){
    localStorage.setItem(KEY_ORDERS, JSON.stringify(orders));
  }

  // ---------- app state ----------
  let master = null;
  let orders = getOrders();
  let currentVendor = null;
  let currentDate = localISODate();

  // ---------- data init ----------
  async function initMaster(){
    const existing = getMaster();
    if(existing){ master = existing; return; }

    const res = await fetch('master_seed.json', {cache:'no-store'});
    const seed = await res.json();
    // normalize
    seed.vendors = (seed.vendors || []).map(v => ({
      name: String(v.name || '').trim(),
      channel: String(v.channel || DEFAULT_VENDOR_CHANNEL[String(v.name||'').trim()] || 'web'),
      items: (v.items || []).map(it => ({
        name: String(it.name || '').trim(),
        unit: String(it.unit || ''),
        memo: String(it.memo || '')
      })).filter(it => it.name)
    })).filter(v => v.name);

    master = seed;
    setMaster(master);
  }

  function ensureDay(date){
    if(!orders[date]) orders[date] = {};
    for(const v of master.vendors){
      if(!orders[date][v.name]) orders[date][v.name] = {};
    }
  }

  function getQty(date, vendor, itemName){
    ensureDay(date);
    const x = orders[date][vendor][itemName];
    return x ? Number(x.qty || 0) : 0;
  }

  function setQty(date, vendor, item){
    ensureDay(date);
    if(!orders[date][vendor][item.name]) orders[date][vendor][item.name] = {qty:0, unit:item.unit, memo:item.memo};
    orders[date][vendor][item.name].qty = Number(item.qty || 0);
    orders[date][vendor][item.name].unit = item.unit || '';
    orders[date][vendor][item.name].memo = item.memo || '';
    scheduleSave();
  }

  function scheduleSave(){
    markSaving();
    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
      setOrders(orders);
      markSaved();
    }, 250);
  }

  // ---------- rendering ----------
  function renderVendors(){
    const list = $('#vendorList');
    list.innerHTML = '';
    const day = orders[currentDate] || {};

    master.vendors.forEach(v => {
      const count = Object.values((day[v.name]||{})).reduce((acc, it) => acc + (Number(it.qty||0)>0 ? 1 : 0), 0);
      const el = document.createElement('div');
      el.className = 'vendorItem';
      el.innerHTML = `
        <div>
          <div class="name">${escapeHtml(v.name)}</div>
          <div class="muted" style="font-size:12px">${channelLabel(v.channel || vendorChannel(v.name))} ・ 商品 ${v.items.length} 件</div>
        </div>
        <div class="row" style="gap:8px">
          <span class="badge">${channelLabel(vendorChannel(v.name))}</span>
          <span class="badge ${count>0?'ok':''}">${count>0?`入力 ${count}`:'未入力'}</span>
          <span class="badge">→</span>
        </div>
      `;
      el.addEventListener('click', () => {
        currentVendor = v.name;
        $('#vendorTitle').textContent = `商品：${v.name}`;
        $('#itemSearch').value = '';
        renderItems();
      });
      list.appendChild(el);
    });

    // auto select first
    if(!currentVendor && master.vendors.length){
      currentVendor = master.vendors[0].name;
      $('#vendorTitle').textContent = `商品：${currentVendor}`;
      renderItems();
    }
  }

  function renderItems(){
    const v = master.vendors.find(x => x.name === currentVendor);
    const list = $('#itemList');
    list.innerHTML = '';
    if(!v){
      list.innerHTML = `<div class="muted">業者を選んでください</div>`;
      return;
    }

    const q = ($('#itemSearch').value || '').trim().toLowerCase();
    const items = v.items.filter(it => !q || it.name.toLowerCase().includes(q) || (it.memo||'').toLowerCase().includes(q));

    if(items.length === 0){
      list.innerHTML = `<div class="muted">該当なし。商品追加もできます。</div>`;
      return;
    }

    for(const it of items){
      const qty = getQty(currentDate, v.name, it.name);
      const row = document.createElement('div');
      row.className = 'itemRow';
      row.innerHTML = `
        <div>
          <div class="itemName">${escapeHtml(it.name)}</div>
          <div class="itemMeta">
            ${it.unit ? `<span class="pill">単位：${escapeHtml(it.unit)}</span>` : `<span class="pill">単位：未設定</span>`}
            ${it.memo ? `<span class="pill">メモ：${escapeHtml(it.memo)}</span>` : ``}
          </div>
        </div>
        <div class="qtyBox">
          <button class="qtyBtn" data-delta="-1">−</button>
          <input class="qtyInput" inputmode="numeric" pattern="[0-9]*" value="${qty}" />
          <button class="qtyBtn" data-delta="+1">＋</button>
        </div>
      `;

      const input = row.querySelector('.qtyInput');
      const minus = row.querySelectorAll('.qtyBtn')[0];
      const plus = row.querySelectorAll('.qtyBtn')[1];

      const clamp = (n) => {
        if(!Number.isFinite(n) || n<0) return 0;
        if(n>9999) return 9999;
        return Math.round(n);
      };

      function commit(n){
        const newQty = clamp(n);
        input.value = String(newQty);
        setQty(currentDate, v.name, {...it, qty:newQty});
        renderVendorBadge(v.name);
        renderTodaySummary(false);
      }

      minus.addEventListener('click', () => commit(Number(input.value||0) - 1));
      plus.addEventListener('click', () => commit(Number(input.value||0) + 1));

      input.addEventListener('change', () => {
        const n = Number(String(input.value).replace(/[^0-9]/g,''));
        commit(n);
      });

      // long press to zero? (optional)
      input.addEventListener('dblclick', () => commit(0));

      list.appendChild(row);
    }
  }

  function renderVendorBadge(vendor){
    // quick refresh of vendor list counts
    renderVendors();
  }

  function fmtMD(date){
    const parts = String(date).split('-');
    if(parts.length!==3) return date;
    const m = String(parseInt(parts[1],10));
    const d = String(parseInt(parts[2],10));
    return `${m}/${d}`;
  }

  function collectVendorLines(date, vendor){
    ensureDay(date);
    const entries = orders[date][vendor] || {};
    const lines = [];
    const vObj = master.vendors.find(v=>v.name===vendor);
    for(const it of (vObj?.items || [])){
      const x = entries[it.name];
      const qty = Number(x?.qty || 0);
      if(qty>0){
        const unit = x?.unit || it.unit || '';
        const memo = x?.memo || it.memo || '';
        lines.push({name: it.name, qty, unit, memo});
      }
    }
    return lines;
  }

  function buildTextForVendor(date, vendor){
    const ch = vendorChannel(vendor);
    const items = collectVendorLines(date, vendor);

    // LINE向け：そのまま貼れる文章
    if(ch === 'line'){
      const out = [];
      out.push(`${vendor}さん`);
      out.push('いつもありがとうございます。KU-DETAです。');
      out.push(`【${fmtMD(date)}】発注お願いします。`);
      if(!items.length){
        out.push('（今回は発注なしです）');
      }else{
        for(const it of items){
          out.push(`・${it.name} ${it.qty}${it.unit ? ' ' + it.unit : ''}${it.memo ? '（' + it.memo + '）' : ''}`);
        }
      }
      out.push('以上、よろしくお願いします。');
      return out.join('\n');
    }

    // WEB / Infomart向け：転記しやすいリスト
    const out = [];
    out.push(`【${date}】 ${vendor} 発注（${channelLabel(ch)}）`);
    if(!items.length){
      out.push('- （入力なし）');
      return out.join('\n');
    }

    for(const it of items){
      const qtyPart = `${it.qty}${it.unit ? ' ' + it.unit : ''}`;
      if(ch === 'infomart'){
        // 表計算的に揃うようタブ区切り寄り
        out.push(`${it.name}	${qtyPart}${it.memo ? '	' + it.memo : ''}`);
      }else{
        // WEBフォームは短めで
        out.push(`- ${it.name}：${qtyPart}${it.memo ? '（' + it.memo + '）' : ''}`);
      }
    }
    return out.join('\n');
  }

  function buildCSVRowsForVendor(date, vendor){
    const ch = vendorChannel(vendor);
    const items = collectVendorLines(date, vendor);
    // 汎用：Infomart転記・バックアップ用途
    const rows = [['date','vendor','channel','item','qty','unit','memo']];
    for(const it of items){
      rows.push([date, vendor, channelLabel(ch), it.name, it.qty, it.unit || '', it.memo || '']);
    }
    return rows;
  }

  function buildAllText(date){
    const blocks = [];
    for(const v of master.vendors){
      // include only if has at least one qty
      const has = collectVendorLines(date, v.name).length > 0;
      if(has) blocks.push(buildTextForVendor(date, v.name));
    }
    return blocks.length ? blocks.join('\n\n') : `【${date}】 発注（入力なし）`;
  }

  function buildAllCSVRows(date){
    const rows = [['date','vendor','item','qty','unit','memo']];
    ensureDay(date);
    for(const v of master.vendors){
      const entries = orders[date][v.name] || {};
      for(const it of v.items){
        const x = entries[it.name];
        const qty = Number(x?.qty || 0);
        if(qty>0){
          rows.push([date, v.name, it.name, qty, x?.unit || it.unit || '', x?.memo || it.memo || '']);
        }
      }
    }
    return rows;
  }

  function renderTodaySummary(scrollTop=true){
    const wrap = $('#todaySummary');
    wrap.innerHTML = '';

    let any = false;
    for(const v of master.vendors){
      const has = collectVendorLines(currentDate, v.name).length > 0;
      if(!has) continue;
      const txt = buildTextForVendor(currentDate, v.name);
      any = true;

      const card = document.createElement('div');
      card.className = 'card';
      card.style.background = 'rgba(249,250,251,.95)';
      card.style.borderRadius = '18px';
      card.style.boxShadow = 'none';
      card.innerHTML = `
        <div class="split">
          <div style="font-weight:900">${escapeHtml(v.name)} <span class="badge" style="margin-left:6px">${channelLabel(vendorChannel(v.name))}</span></div>
          <div class="row">
            <button class="btn small" data-act="copy">コピー</button>
            <button class="btn small" data-act="txt">TXT保存</button>
            ${vendorChannel(v.name)==='infomart' ? '<button class="btn small" data-act="csv">CSV</button>' : ''}
          </div>
        </div>
        <div class="hr"></div>
        <textarea readonly class="mono">${escapeHtml(txt)}</textarea>
      `;

      card.querySelector('[data-act="copy"]').addEventListener('click', () => copyToClipboard(txt));
      card.querySelector('[data-act="txt"]').addEventListener('click', () => downloadText(`${currentDate}_${v.name}_発注.txt`, txt));

      const csvBtn = card.querySelector('[data-act="csv"]');
      if(csvBtn){
        csvBtn.addEventListener('click', () => {
          const rows = buildCSVRowsForVendor(currentDate, v.name);
          downloadCSV(`${currentDate}_${v.name}_発注.csv`, rows);
          toast('CSVを保存しました');
        });
      }

      wrap.appendChild(card);
    }

    if(!any){
      wrap.innerHTML = `<div class="muted">まだ入力がありません。業者タブで数量を入れるとここにまとまります。</div>`;
    }

    if(scrollTop) window.scrollTo({top:0, behavior:'smooth'});
  }

  function renderHistory(){
    const list = $('#historyList');
    list.innerHTML = '';
    const dates = Object.keys(orders).sort((a,b)=> b.localeCompare(a));
    if(!dates.length){
      list.innerHTML = `<div class="muted">履歴なし</div>`;
      return;
    }

    for(const d of dates){
      const day = orders[d] || {};
      let lines = 0;
      for(const v of Object.keys(day)){
        lines += Object.values(day[v]||{}).reduce((acc,x)=> acc + (Number(x.qty||0)>0?1:0), 0);
      }
      const el = document.createElement('div');
      el.className = 'vendorItem';
      el.innerHTML = `
        <div>
          <div class="name">${escapeHtml(d)}</div>
          <div class="muted" style="font-size:12px">入力 ${lines} 件</div>
        </div>
        <div class="row" style="gap:8px">
          <span class="badge">読み込む</span>
          <span class="badge">→</span>
        </div>
      `;
      el.addEventListener('click', () => {
        $('#date').value = d;
        onDateChange(d);
        setTab('today');
      });
      list.appendChild(el);
    }
  }

  function escapeHtml(s){
    return String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }

  // ---------- actions ----------
  function onDateChange(d){
    currentDate = d;
    ensureDay(currentDate);
    scheduleSave();
    renderVendors();
    renderItems();
    renderTodaySummary(false);
    renderHistory();
  }

  function setTab(name){
    $$('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name));
    $$('.view').forEach(v => v.style.display = 'none');
    $('#view-' + name).style.display = 'block';
    if(name==='today') renderTodaySummary();
    if(name==='history') renderHistory();
  }

  // ---------- PWA install ----------
  let deferredPrompt = null;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    const btn = $('#installBtn');
    btn.style.display = 'inline-block';
  });
  $('#installBtn').addEventListener('click', async () => {
    if(!deferredPrompt){ toast('この端末では表示できません'); return; }
    deferredPrompt.prompt();
    const choice = await deferredPrompt.userChoice;
    if(choice?.outcome === 'accepted') toast('追加しました');
    deferredPrompt = null;
    $('#installBtn').style.display = 'none';
  });

  // ---------- boot ----------
  async function boot(){
    await initMaster();

    // date
    $('#date').value = currentDate;
    $('#date').addEventListener('change', (e) => onDateChange(e.target.value));

    // quick date controls
    const p = $('#prevDayBtn');
    const n = $('#nextDayBtn');
    const t = $('#todayBtn');
    const setAndChange = (d) => { $('#date').value = d; onDateChange(d); };
    if(p) p.addEventListener('click', () => setAndChange(addDays(currentDate, -1)));
    if(n) n.addEventListener('click', () => setAndChange(addDays(currentDate, 1)));
    if(t) t.addEventListener('click', () => setAndChange(localISODate()));


    // tabs
    $$('.tab').forEach(t => t.addEventListener('click', () => setTab(t.dataset.tab)));

    // search
    $('#itemSearch').addEventListener('input', () => renderItems());

    // to today
    $('#toTodayBtn').addEventListener('click', () => setTab('today'));

    // clear vendor
    $('#clearVendorBtn').addEventListener('click', () => {
      if(!currentVendor) return;
      ensureDay(currentDate);
      const v = master.vendors.find(x => x.name === currentVendor);
      if(!v) return;
      for(const it of v.items){
        if(orders[currentDate][currentVendor]?.[it.name]) orders[currentDate][currentVendor][it.name].qty = 0;
      }
      scheduleSave();
      renderItems();
      renderVendors();
      renderTodaySummary(false);
      toast('この業者を0にしました');
    });

    // clear day
    $('#clearDayBtn').addEventListener('click', () => {
      ensureDay(currentDate);
      for(const v of master.vendors){
        const entries = orders[currentDate][v.name] || {};
        for(const k of Object.keys(entries)) entries[k].qty = 0;
      }
      scheduleSave();
      renderItems();
      renderVendors();
      renderTodaySummary(false);
      toast('今日を全部0にしました');
    });

    // copy all
    $('#copyAllBtn').addEventListener('click', () => copyToClipboard(buildAllText(currentDate)));

    // csv all
    $('#csvAllBtn').addEventListener('click', () => {
      const rows = buildAllCSVRows(currentDate);
      downloadCSV(`${currentDate}_発注.csv`, rows);
      toast('CSVを保存しました');
    });

    // add item
    $('#addItemBtn').addEventListener('click', () => {
      if(!currentVendor){ toast('業者を選んでください'); return; }
      const name = prompt('商品名（例：無塩バター）');
      if(!name) return;
      const unit = prompt('単位（例：kg / 本 / 袋 / ケース など）※空でもOK') || '';
      const memo = prompt('メモ（任意）') || '';
      const v = master.vendors.find(x => x.name === currentVendor);
      if(!v) return;
      const exists = v.items.some(it => it.name === name.trim());
      if(exists){ toast('同名の商品があります'); return; }
      v.items.push({name:name.trim(), unit:unit.trim(), memo:memo.trim()});
      // keep sorted (jp-ish)
      v.items.sort((a,b)=> a.name.localeCompare(b.name,'ja'));
      setMaster(master);
      renderVendors();
      renderItems();
      toast('商品を追加しました');
    });

    // wipe all
    $('#wipeAllBtn').addEventListener('click', () => {
      const ok = confirm('端末内の「発注履歴」をすべて削除します。よろしいですか？');
      if(!ok) return;
      orders = {};
      setOrders(orders);
      renderHistory();
      renderTodaySummary(false);
      renderVendors();
      renderItems();
      toast('削除しました');
    });

    // settings export/import/reset
    $('#exportMasterBtn').addEventListener('click', () => {
      const text = JSON.stringify(master, null, 2);
      downloadText(`master_${localISODate()}.json`, text);
      toast('書き出しました');
    });

    $('#importMaster').addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if(!file) return;
      const text = await file.text();
      try{
        const m = JSON.parse(text);
        if(!m?.vendors) throw new Error('format');
        master = m;
        setMaster(master);
        renderVendors();
        renderItems();
        renderTodaySummary(false);
        toast('読み込みました');
      }catch(err){
        toast('読み込みに失敗');
      }finally{
        e.target.value = '';
      }
    });

    $('#resetMasterBtn').addEventListener('click', async () => {
      const ok = confirm('マスターを初期状態に戻します（追加した商品は消えます）。よろしいですか？');
      if(!ok) return;
      localStorage.removeItem(KEY_MASTER);
      await initMaster();
      renderVendors();
      renderItems();
      renderTodaySummary(false);
      toast('戻しました');
    });

    // initial render
    ensureDay(currentDate);
    renderVendors();
    renderItems();
    renderTodaySummary(false);
    renderHistory();

    // service worker
    if('serviceWorker' in navigator){
      try{ await navigator.serviceWorker.register('./service-worker.js'); }catch(e){}
    }

    markSaved();
  }

  boot();
  </script>
</body>
</html>
